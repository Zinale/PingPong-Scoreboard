<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scoreboard Live</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="container">
    <h1 class="headline">üèüÔ∏è Live Scoreboard</h1>

    <section class="scores">
      <div class="player-card">
        <h2>Giocatore 1</h2>
        <div class="points">
          <span id="p1" class="value">0</span>
          <span class="unit">pt</span>
        </div>
        <div class="progress"><span id="bar1"></span></div>
      </div>

      <div class="player-card">
        <h2>Giocatore 2</h2>
        <div class="points">
          <span id="p2" class="value">0</span>
          <span class="unit">pt</span>
        </div>
        <div class="progress"><span id="bar2"></span></div>
      </div>
    </section>

    <footer class="footer">
      <div class="total">
        Totale: <strong id="total">0</strong>
      </div>
      <div class="timestamp">
        Ultimo aggiornamento: <span id="ts">‚Äî</span>
      </div>
    </footer>
  </main>

  <script>
    const elP1 = document.getElementById('p1');
    const elP2 = document.getElementById('p2');
    const elBar1 = document.getElementById('bar1');
    const elBar2 = document.getElementById('bar2');
    const elTotal = document.getElementById('total');
    const elTs = document.getElementById('ts');

    function animateNumber(el, value){
      el.textContent = value;
      el.classList.remove('bump');
      void el.offsetWidth; // restart animation
      el.classList.add('bump');
    }

    function updateBars(p1, p2){
      const total = Math.max(1, p1 + p2);
      elBar1.style.width = ((p1/total)*100).toFixed(1) + '%';
      elBar2.style.width = ((p2/total)*100).toFixed(1) + '%';
    }

    function applyState(s){
      const p1 = parseInt(s.player1||0,10);
      const p2 = parseInt(s.player2||0,10);
      animateNumber(elP1, p1);
      animateNumber(elP2, p2);
      updateBars(p1,p2);
      elTotal.textContent = (p1+p2).toString();
      try{
        const d = new Date(s.updated_at || Date.now());
        elTs.textContent = d.toLocaleString();
      }catch(_){ elTs.textContent = s.updated_at || '‚Äî' }
    }

    fetch('/score').then(r=>r.json()).then(applyState).catch(()=>{});
    const ev = new EventSource('/events');
    ev.addEventListener('score', (e)=>{
      try{ applyState(JSON.parse(e.data)); }catch(err){ console.error(err); }
    });
  </script>
</body>
</html>
